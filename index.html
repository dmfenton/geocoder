<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<meta property="og:title" content="geocoder" />
		<meta property="og:site_name" content="geocoder" />
		<meta property="og:description" content="Simple CSV geocoding interface." />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://emanuelfeld.github.io/geocoder" />
		<meta property="og:image" content="https://emanuelfeld.github.io/geocoder/assets/geocoder_box.png" />
		
		<title>geocoder</title>
		
		<link rel="stylesheet" href="stylesheets/index.css">
		<link rel="stylesheet" href="stylesheets/pygment_trac.css">
		<link rel="shortcut icon" type="image/x-icon" href="assets/geocoder_box.ico" >
		<link href='https://fonts.googleapis.com/css?family=Dosis|Abel|Titillium+Web|Roboto+Condensed' rel='stylesheet' type='text/css'>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

		<meta content="initial-scale=1.0, user-scalable=no" name="viewport">
		<!--[if lt IE 9]>
		<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<!-- Go to www.addthis.com/dashboard to customize your tools -->
		<script src="javascripts/papaparse.min.js"></script>
		<script src="javascripts/jquery.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
		<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5542e6df2a2e5aa7" async="async"></script>
		<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		ga('create', 'UA-61502361-1', 'auto');
		ga('send', 'pageview');
		</script>
	</head>

	<body style="margin:0 auto">
		
 <div id="contents">
 	<div style="display: table-row">

			<div id="instructions"> 
				<div id="title_box">
					<div id="title" class="steps">Geocoder</div>
					<div id="subtitle" class="steps"><a href="/geocoder/about" target="_blank">instructions</a> &nbsp <a href="/geocoder/about#contact" target="_blank">contact</a> &nbsp <a href="https://github.com/emanuelfeld/geocoder" target="_blank">code</a></div>
				</div>
				<div id="file_select" class="steps">
					1. Select your file:<br>
					<input type="file" value="hello" id="files" name="files[]" accept="text/csv,text/tab-separated-values,.txt"/>					
				</div>
				<div id="column_select" class="steps">
					2. Choose a column:<br>
				<select id="field_list" disabled="disabled" class="steps">
					<option selected="selected" disabled="disabled">This Column</option>
				</select>
				</div>
				<div id="run_geocoder" class="steps">
					3. Run the geocoder:<br>
					<button id="geocode_button" type="submit" disabled="disabled">Go!</button>
					<span id="progress"></span>
				</div>
				<div id="download_result" class="steps">
					4. Download the result:<br>
					<button id="download" type="submit" disabled="disabled">CSV</button><br>
					<button id="geojson" type="submit" disabled="disabled">GeoJSON</button>
				</div>
			</div>

		<div id="map"></div>
	</div>

		<script>

			function main() {

				var coordinates = [];
				var lat, lon;
				var info;
				var field_list;
				var failures = 0;
				var successes = 0;
				var geocoder = new google.maps.Geocoder();

				//listen for data upload. right now only csv/tsv type files. also presumes that file contains headers.
				document.getElementById('files').addEventListener('change', handleFileSelect, false);
				document.getElementById('field_list').addEventListener('change', toggleGeocoder, false);
				document.getElementById('geocode_button').addEventListener('click', setupGeocoder, false);

				//initialize map
				var map = L.map('map').setView([51.505, -0.09], 2);
				L.tileLayer('http://{s}.tiles.mapbox.com/v3/evonfriedland.m2bo5h3j/{z}/{x}/{y}.png', {
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
					maxZoom: 18
				}).addTo(map);

				//set up feature group to gather markers
				var markers = L.featureGroup();
				markers.addTo(map);

				function handleFileSelect(evt) {
					var files = evt.target.files;
					var parsed = Papa.parse(files[0], {
						header: true,
						complete: function(results) {
							info = results;
							console.log(info);
							makeList();
						}
					});
				}

				function makeList() {
					console.log("Accessing makeList");
					$(".option").remove();
					field_list = document.getElementById('field_list');
					field_list.removeAttribute("disabled");

					for (var i = 0; i < info.meta.fields.length; i++) {
						var field_option = new Option();
						field_option.setAttribute("class", "option");
						field_option.value = info.meta.fields[i];
						field_option.text = info.meta.fields[i];
						field_list.options.add(field_option);
					}
				}

				function toggleGeocoder() {
					var geocode_button = document.getElementById('geocode_button');
					var selected = document.getElementById('field_list').selectedOptions[0].text;
					if (selected != "This Column") {
						geocode_button.removeAttribute("disabled");
					} else {
						geocode_button.setAttribute("disabled", "disabled");
					}
					console.log(selected);
				}

				function setupGeocoder() {
					failures = 0;
					successes = 0;
					markers.clearLayers();

					var selected_field = document.getElementById('field_list').selectedOptions[0].text;

					iterateRows(selected_field);
				}

				function iterateRows(s) {
					var index = -1;
					var begin = setInterval(function() {
						index++;
						if (index < info.data.length) {
							geocodeRow(index, s);
						} else {
							clearInterval(begin);
						}
					}, 1000);
				}

				function geocodeRow(i, s) {
					var address = info.data[i][s];
					geocoder.geocode({
						'address': address
					}, function(gmap, status) {
						if (status === google.maps.GeocoderStatus.OK) {
							lat = gmap[0].geometry.location['A'];
							lon = gmap[0].geometry.location['F'];
						} else {
							lat = 0;
							lon = 0;
						}
						var address_info = {
							'index': i,
							'latitude': lat,
							'longitude': lon,
							'address': address
						};
						if (lat === 0 & lon === 0) {
							failures++;							
						} else {
							successes++;
							var marker = L.marker([address_info.latitude, address_info.longitude]);
							marker.bindPopup(address_info.address);
							markers.addLayer(marker);
						}
						var progress = document.getElementById('progress');
						progress.textContent = successes + " of " + info.data.length + " geocoded and " + failures + " failures";

						collectPoints(address_info);
					});
				}

				function collectPoints(a) {
					console.log(a);
					if (a.index === 0) {
						coordinate_list = [];
					}

					coordinate_list.push(a);

					if (coordinate_list.length === info.data.length) {
						var lat_list = [];
						var lon_list = [];
						var output_csv = [];
						var output_geojson = [];
						for (var i = 0; i < info.data.length; i++) {
							lat_list.push(coordinate_list[i].latitude);
							lon_list.push(coordinate_list[i].longitude);
							output_csv[i] = jQuery.extend({}, info.data[i], {
								'latitude': coordinate_list[i].latitude
							}, {
								'longitude': coordinate_list[i].longitude
							});
							output_geojson[i] = jQuery.extend({}, {
								'properties': info.data[i]
							}, {
								'type': 'Feature',
								'geometry': {
									'type': 'Point',
									'coordinates': [coordinate_list[i].longitude, coordinate_list[i].latitude]
								}
							});

						}

						output_geojson = {
							'type': 'FeatureCollection',
							'features': output_geojson
						};
						output_geojson = JSON.stringify(output_geojson, null, '\t');

						console.log(output_geojson);

						min_lat = Math.min.apply(Math, lat_list);
						max_lat = Math.max.apply(Math, lat_list);
						min_lon = Math.min.apply(Math, lon_list);
						max_lon = Math.max.apply(Math, lon_list);

						map.fitBounds([
							[min_lat, min_lon],
							[max_lat, max_lon]
						]);

						var csv = Papa.unparse(output_csv);

						console.log(csv);

						var geojson = document.getElementById('geojson');
						geojson.removeAttribute("disabled");
						geojson.textContent = "";
						var geojson_link = document.createElement('a');
						geojson_link.innerHTML = "GeoJSON";
						geojson_link.href = "data:text/json;charset=utf-8," + encodeURIComponent(output_geojson);
						geojson_link.target = '_blank';
						geojson_link.download = "geojson.json";
						geojson.appendChild(geojson_link);


						var download = document.getElementById('download');
						download.removeAttribute("disabled");
						download.textContent = "";
						var download_link = document.createElement('a');
						download_link.innerHTML = "CSV";
						download_link.href = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);
						download_link.target = '_blank';
						download_link.download = 'geocoded.csv';
						download.appendChild(download_link);
					}
				}

			}

			window.onload = main;

		</script>

		<script src="javascripts/scale.fix.js"></script>

		<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5542e6df2a2e5aa7" async="async"></script>

  	</body>
</html>
